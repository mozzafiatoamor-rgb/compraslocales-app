<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f1a14">
<title>Mozzafiato Compras</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1a14;--surface:#1a2e22;--surface2:#243a2c;--surface3:#2e4a38;--accent:#34d399;--accent2:#6ee7b7;--green:#34d399;--red:#f87171;--yellow:#fbbf24;--blue:#60a5fa;--cyan:#22d3ee;--orange:#fb923c;--text:#e0f0e8;--text2:#88a898;--radius:14px}
html,body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none;-webkit-text-size-adjust:100%}
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px 6px;background:var(--bg);position:sticky;top:0;z-index:100}
.status-left{display:flex;align-items:center;gap:10px}.app-logo{height:36px;width:auto;object-fit:contain}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--red);animation:pulse 2s infinite}.status-dot.connected{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-right{display:flex;align-items:center;gap:8px}
.user-badge{display:flex;align-items:center;gap:6px;background:var(--surface2);padding:4px 10px 4px 8px;border-radius:8px;font-size:11px;color:var(--text2);cursor:pointer;border:none;font-family:'DM Sans',sans-serif}
.user-avatar{width:22px;height:22px;border-radius:6px;background:var(--accent);color:#0f1a14;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.user-name{font-weight:600;color:var(--text)}
.config-btn{background:var(--surface2);border:none;color:var(--text2);width:36px;height:36px;border-radius:10px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.main-content{height:calc(100vh - 52px - 70px);overflow-y:scroll;padding:0 16px 80px;-webkit-overflow-scrolling:touch;touch-action:pan-y}.main-content::-webkit-scrollbar{display:none}
.card{background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:14px;border:1px solid rgba(255,255,255,.04);animation:slideUp .4s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.stats-grid.three{grid-template-columns:1fr 1fr 1fr}
.stat-box{background:var(--surface2);border-radius:12px;padding:16px;text-align:center;position:relative;overflow:hidden}
.stat-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0}
.stat-box.green::before{background:var(--green)}.stat-box.red::before{background:var(--red)}.stat-box.blue::before{background:var(--blue)}.stat-box.orange::before{background:var(--orange)}.stat-box.yellow::before{background:var(--yellow)}.stat-box.cyan::before{background:var(--cyan)}
.stat-number{font-family:'Space Mono',monospace;font-size:24px;font-weight:700;line-height:1}
.stat-label{font-size:10px;color:var(--text2);margin-top:6px;text-transform:uppercase;letter-spacing:.5px}
.inv-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface2);border-radius:10px;margin-bottom:8px;position:relative}
.inv-name{font-size:14px;font-weight:500}.inv-cat{font-size:11px;color:var(--text2);margin-top:2px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;text-transform:uppercase}
.badge.critical{background:rgba(248,113,113,.15);color:var(--red)}.badge.warning{background:rgba(251,191,36,.15);color:var(--yellow)}.badge.good{background:rgba(52,211,153,.15);color:var(--green)}.badge.info{background:rgba(96,165,250,.15);color:var(--blue)}.badge.pending{background:rgba(251,191,36,.15);color:var(--yellow)}.badge.closed{background:rgba(52,211,153,.15);color:var(--green)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid rgba(255,255,255,.06);display:flex;height:70px;padding-bottom:env(safe-area-inset-bottom);z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;border:none;background:none;color:var(--text2);font-size:9px;font-weight:500;cursor:pointer;position:relative;font-family:'DM Sans',sans-serif}
.nav-item.active{color:var(--accent)}.nav-item.active::before{content:'';position:absolute;top:0;width:32px;height:3px;background:var(--accent);border-radius:0 0 3px 3px}
.nav-icon{font-size:20px}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--surface2);border:1px solid rgba(255,255,255,.06);border-radius:10px;color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;-webkit-appearance:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent)}
.form-select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2388a898' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.form-textarea{resize:none;height:80px}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.97)}.btn-primary{background:var(--accent);color:#0f1a14}.btn-primary:disabled{opacity:.4}
.btn-secondary{background:var(--surface2);color:var(--text)}.btn-success{background:var(--green);color:#0f1a14}.btn-danger{background:var(--red);color:#fff}.btn-orange{background:var(--orange);color:#0f1a14}.btn-blue{background:var(--blue);color:#0f1a14}
.btn-sm{padding:10px 16px;font-size:13px;width:auto;border-radius:10px}
.quick-actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px}
.quick-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;background:var(--surface2);border-radius:var(--radius);border:none;cursor:pointer;color:var(--text);font-family:'DM Sans',sans-serif}
.quick-btn:active{transform:scale(.96)}.quick-btn.disabled{opacity:.35;pointer-events:none}
.quick-icon{font-size:24px}.quick-label{font-size:11px;font-weight:600}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:24px 20px 40px;max-height:90vh;overflow-y:scroll;-webkit-overflow-scrolling:touch;touch-action:pan-y;animation:slideModal .3s ease}
@keyframes slideModal{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--surface3);border-radius:4px;margin:0 auto 20px}
.modal-title{font-size:20px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--green);color:#0f1a14;padding:12px 24px;border-radius:12px;font-weight:600;font-size:14px;z-index:300;transition:transform .4s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:8px;white-space:nowrap;max-width:90vw}
.toast.error{background:var(--red);color:#fff}.toast.show{transform:translateX(-50%) translateY(0)}
.setup-screen{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}
.setup-logo{height:60px;width:auto;margin-bottom:20px;object-fit:contain}
.setup-title{font-size:24px;font-weight:700;margin-bottom:10px}
.setup-desc{font-size:14px;color:var(--text2);margin-bottom:30px;line-height:1.6;max-width:320px}
.setup-input,.login-input{width:100%;max-width:360px;padding:16px;background:var(--surface);border:2px solid var(--surface3);border-radius:12px;color:var(--text);font-size:16px;font-family:'DM Sans',sans-serif;text-align:center;margin-bottom:12px}
.setup-input{font-family:'Space Mono',monospace;font-size:13px}
.setup-input:focus,.login-input:focus{outline:none;border-color:var(--accent)}
.step-indicator{display:flex;gap:8px;margin-bottom:20px}.step-dot{width:8px;height:8px;border-radius:50%;background:var(--surface3)}.step-dot.active{background:var(--accent);width:24px;border-radius:4px}
.search-bar{display:flex;align-items:center;gap:10px;background:var(--surface2);border-radius:10px;padding:0 14px;margin-bottom:14px}
.search-bar input{flex:1;padding:12px 0;background:none;border:none;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif}
.search-bar input:focus{outline:none}
.tab-pills{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}.tab-pills::-webkit-scrollbar{display:none}
.tab-pill{padding:7px 12px;border-radius:8px;border:none;background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;font-family:'DM Sans',sans-serif;white-space:nowrap;cursor:pointer}
.tab-pill.active{background:var(--accent);color:#0f1a14}
.empty-state{text-align:center;padding:40px 20px;color:var(--text2)}.empty-state .empty-icon{font-size:48px;margin-bottom:12px}
.record-item{background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:8px;position:relative}
.record-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.record-product{font-size:14px;font-weight:600}
.record-qty{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:var(--accent)}
.record-meta{font-size:11px;color:var(--text2);display:flex;gap:10px;flex-wrap:wrap}
.uib{background:var(--surface2);border-radius:10px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px}
.uib-av{width:32px;height:32px;border-radius:8px;background:var(--accent);color:#0f1a14;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
.uib-name{font-weight:600}.uib-role{font-size:11px;color:var(--text2)}
.cart-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;animation:slideUp .3s ease}
.cart-item .ci-info{flex:1}.cart-item .ci-name{font-size:13px;font-weight:600}.cart-item .ci-meta{font-size:10px;color:var(--text2)}
.cart-item .ci-qty{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);margin:0 8px}
.cart-item .ci-price{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:var(--yellow);margin-right:8px}
.cart-item .ci-del{background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;padding:4px}
.cart-header{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}.cart-header .ch-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase}.cart-header .ch-count{font-size:11px;color:var(--accent);font-weight:700}
.cart-divider{height:1px;background:rgba(255,255,255,.06);margin:16px 0}
.cart-total{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:var(--surface3);border-radius:10px;margin:10px 0;font-weight:700}
.cart-total .ct-label{font-size:13px;color:var(--text2)}.cart-total .ct-amount{font-family:'Space Mono',monospace;font-size:18px;color:var(--yellow)}
.cuadre-box{background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid var(--surface3)}
.cuadre-box.ok{border-left-color:var(--green)}.cuadre-box.warn{border-left-color:var(--yellow)}.cuadre-box.bad{border-left-color:var(--red)}
.cuadre-row{display:flex;justify-content:space-between;padding:6px 0;font-size:14px}
.cuadre-row .cr-val{font-family:'Space Mono',monospace;font-weight:700}
.del-btn{position:absolute;top:8px;right:8px;background:rgba(248,113,113,.15);border:none;color:var(--red);width:28px;height:28px;border-radius:6px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:250;display:flex;align-items:center;justify-content:center;padding:20px}
.confirm-box{background:var(--surface);border-radius:16px;padding:24px;max-width:340px;width:100%;text-align:center}
.confirm-box .confirm-title{font-size:18px;font-weight:700;margin-bottom:8px}
.confirm-box .confirm-msg{font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.5}
.confirm-box .confirm-btns{display:flex;gap:10px}.confirm-box .confirm-btns .btn{flex:1}
.autocomplete-wrap{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--surface3);border-radius:0 0 10px 10px;max-height:200px;overflow-y:auto;z-index:50;display:none}
.autocomplete-list.open{display:block}
.autocomplete-item{padding:12px 16px;font-size:14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.04);display:flex;justify-content:space-between}
.autocomplete-item:active,.autocomplete-item.highlighted{background:var(--surface2)}
.autocomplete-item:last-child{border:none;border-radius:0 0 10px 10px}
.autocomplete-item .ac-cat{font-size:10px;color:var(--text2)}
.autocomplete-item .ac-match{color:var(--accent);font-weight:600}
.ac-selected{background:var(--surface2);border:1px solid var(--accent);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.ac-selected .ac-clear{background:none;border:none;color:var(--red);font-size:18px;cursor:pointer}
.ticket-indicator{display:flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:6px}
.ticket-si{background:rgba(52,211,153,.1);color:var(--green)}.ticket-no{background:rgba(248,113,113,.1);color:var(--red)}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div id="confirmDialog" style="display:none"></div>
<div id="app"></div>
<script>
const LOGO='logo.png';
let SCRIPT_URL=localStorage.getItem('scriptUrl_compras')||'';
const S={screen:'setup',setupStep:1,tab:'home',sheetId:localStorage.getItem('sheetId_compras')||'',apiKey:localStorage.getItem('apiKey_compras')||'',connected:false,currentUser:null,usuarios:[],catalogo:[],proveedores:[],compras:[],fondos:[],bitacora:[],loading:false,searchQuery:'',comprasFilter:'todos',cuadreDate:''};

const Sheets={
  async read(sh,rg){const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${S.sheetId}/values/${encodeURIComponent(sh)}!${rg}?key=${S.apiKey}`);if(!r.ok)throw new Error(r.status);const d=await r.json();return d.values||[]},
  async append(sh,v){const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'append',sheet:sh,values:v})});const d=await r.json();if(!d.success)throw new Error(d.error);return d},
  async deleteRow(sh,rowNum){const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'delete',sheet:sh,row:rowNum})});const d=await r.json();if(!d.success)throw new Error(d.error);return d},
  async loadUsers(){try{const rows=await this.read('\u{1F464} Usuarios','A2:E50');S.usuarios=rows.map(r=>({id:r[0]||'',usuario:r[1]||'',password:r[2]||'',nombre:r[3]||'',rol:(r[4]||'comprador').toLowerCase()})).filter(u=>u.usuario);return true}catch(e){console.error(e);return false}},
  async loadAll(){S.loading=true;render();try{
    const c=await this.read('\u{1F6D2} Cat\u00e1logo','A2:F200');S.catalogo=c.map((r,i)=>({id:r[0]||'',categoria:r[1]||'',producto:r[2]||'',unidad:r[3]||'',precioRef:parseFloat(r[4])||0,activo:(r[5]||'SI').toUpperCase(),_row:i+2})).filter(p=>p.producto&&p.activo!=='NO');
    const pv=await this.read('\u{1F3EA} Proveedores','A2:D50');S.proveedores=pv.map((r,i)=>({id:r[0]||'',nombre:r[1]||'',tipo:r[2]||'',activo:(r[3]||'SI').toUpperCase(),_row:i+2})).filter(p=>p.nombre&&p.activo!=='NO');
    const cp=await this.read('\u{1F9FE} Compras','A2:L1000');S.compras=cp.map((r,i)=>({id:r[0]||'',fecha:r[1]||'',hora:r[2]||'',categoria:r[3]||'',producto:r[4]||'',cantidad:parseFloat(r[5])||0,unidad:r[6]||'',precio:parseFloat(r[7])||0,proveedor:r[8]||'',ticket:r[9]||'',comprador:r[10]||'',notas:r[11]||'',_row:i+2})).filter(p=>p.producto).reverse().slice(0,200);
    const fd=await this.read('\u{1F4B5} Fondos','A2:G500');S.fondos=fd.map((r,i)=>({id:r[0]||'',fecha:r[1]||'',hora:r[2]||'',tipo:r[3]||'',monto:parseFloat(r[4])||0,responsable:r[5]||'',notas:r[6]||'',_row:i+2})).filter(f=>f.tipo).reverse().slice(0,100);
    const bt=await this.read('\u{1F4DC} Bit\u00e1cora','A2:F500');S.bitacora=bt.map(r=>({fecha:r[0]||'',hora:r[1]||'',usuario:r[2]||'',accion:r[3]||'',detalle:r[4]||'',tipo:r[5]||''})).filter(b=>b.accion).reverse().slice(0,100);
    S.connected=true}catch(e){console.error(e);toast('Error al cargar',1);S.connected=false}S.loading=false;render()}
};

function toast(m,e){const t=document.getElementById('toast');t.textContent=(e?'\u26a0\ufe0f ':'\u2705 ')+m;t.className='toast show'+(e?' error':'');setTimeout(()=>t.className='toast',2500)}
function now(){const d=new Date();return{date:d.toLocaleDateString('es-MX',{year:'numeric',month:'2-digit',day:'2-digit'}),time:d.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}}
function today(){return now().date}
function fmt$(n){return'$'+n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}
function nextId(p,l){const n=l.map(r=>parseInt((r.id||'0').replace(/\D/g,''))||0);return p+String((n.length?Math.max(...n):0)+1).padStart(4,'0')}
function getCats(){return[...new Set(S.catalogo.map(p=>p.categoria))].filter(Boolean).sort()}
function getProds(c){return c?S.catalogo.filter(p=>p.categoria===c):S.catalogo}
function getProvs(){return S.proveedores.map(p=>p.nombre).sort()}
function isDup(n,c){return S.catalogo.some(p=>p.producto.trim().toLowerCase()===n.trim().toLowerCase()&&p.categoria.trim().toLowerCase()===c.trim().toLowerCase())}
function isAdmin(){return S.currentUser&&S.currentUser.rol==='admin'}
function uName(){return S.currentUser?S.currentUser.nombre:''}
function uInit(){if(!S.currentUser)return'?';return S.currentUser.nombre.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2)}
function getDayFondos(d){return S.fondos.filter(f=>f.fecha===d)}
function getDayCompras(d){return S.compras.filter(c=>c.fecha===d)}
function getDaySummary(d){const fondos=getDayFondos(d);const compras=getDayCompras(d);const asignado=fondos.filter(f=>f.tipo==='Asignaci\u00f3n').reduce((s,f)=>s+f.monto,0);const devuelto=fondos.filter(f=>f.tipo==='Devoluci\u00f3n').reduce((s,f)=>s+f.monto,0);const gastado=compras.reduce((s,c)=>s+c.precio,0);const cerrado=fondos.some(f=>f.tipo==='Cierre');return{asignado,devuelto,gastado,disponible:asignado-devuelto-gastado,cerrado,items:compras.length}}
async function logAction(a,d,t){const n=now();try{await Sheets.append('\u{1F4DC} Bit\u00e1cora',[n.date,n.time,uName(),a,d,t])}catch(e){}}

function showConfirm(title,msg,onYes){window._confirmYes=onYes;const cd=document.getElementById('confirmDialog');cd.style.display='block';cd.innerHTML='<div class="confirm-overlay" onclick="if(event.target===this)hideConfirm()"><div class="confirm-box"><div class="confirm-title">'+title+'</div><div class="confirm-msg">'+msg+'</div><div class="confirm-btns"><button class="btn btn-secondary btn-sm" onclick="hideConfirm()">Cancelar</button><button class="btn btn-danger btn-sm" onclick="hideConfirm();window._confirmYes()">Confirmar</button></div></div></div>'}
function hideConfirm(){document.getElementById('confirmDialog').style.display='none'}

let _acSelected={};
function acInput(inputId,list,labelFn){const v=document.getElementById(inputId).value.toLowerCase();const el=document.getElementById(inputId+'List');if(!v){el.className='autocomplete-list';return}const f=list.filter(p=>labelFn(p).toLowerCase().includes(v));if(!f.length){el.innerHTML='<div class="autocomplete-item" style="color:var(--text2)">Sin resultados</div>';el.className='autocomplete-list open';return}el.innerHTML=f.slice(0,15).map(p=>{const lb=labelFn(p);const i=lb.toLowerCase().indexOf(v);return'<div class="autocomplete-item" onclick="acPick(\''+inputId+'\',\''+lb.replace(/'/g,"\\'")+'\')"><div>'+lb.substring(0,i)+'<span class="ac-match">'+lb.substring(i,i+v.length)+'</span>'+lb.substring(i+v.length)+'</div></div>'}).join('');el.className='autocomplete-list open'}
function acPick(inputId,val){_acSelected[inputId]=val;const wrap=document.getElementById(inputId+'Wrap');wrap.innerHTML='<div class="ac-selected"><strong>'+val+'</strong><button class="ac-clear" onclick="acClearC(\''+inputId+'\')">\u2716</button></div>'}
function acClearC(inputId){_acSelected[inputId]='';const wrap=document.getElementById(inputId+'Wrap');wrap.innerHTML='<div class="autocomplete-wrap"><input class="form-input" id="'+inputId+'" placeholder="\u{1F50D} Buscar..." oninput="acInputFor(\''+inputId+'\')" onfocus="acInputFor(\''+inputId+'\')" autocomplete="off"><div class="autocomplete-list" id="'+inputId+'List"></div></div>'}
function acGetVal(id){return _acSelected[id]||''}
function acInputFor(id){if(id==='fCP')acInput(id,S.catalogo,p=>p.producto);else if(id==='fCPv')acInput(id,S.proveedores,p=>p.nombre);else if(id==='fNProd')acInput(id,S.catalogo,p=>p.producto)}
document.addEventListener('click',function(e){document.querySelectorAll('.autocomplete-list.open').forEach(l=>{if(!l.parentElement.contains(e.target))l.className='autocomplete-list'})})

function render(){const a=document.getElementById('app');if(S.screen==='setup')a.innerHTML=renderSetup();else if(S.screen==='login')a.innerHTML=renderLogin();else a.innerHTML=renderMain()}

function renderSetup(){
  if(S.setupStep===1)return'<div class="setup-screen"><div class="step-indicator"><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div></div><img src="'+LOGO+'" class="setup-logo" onerror="this.style.display=\'none\'"><div class="setup-title">\u{1F6D2} Compras</div><div class="setup-desc">ID del Google Sheet</div><input class="setup-input" id="si" placeholder="Sheet ID" value="'+S.sheetId+'" oninput="S.sheetId=this.value.trim();document.getElementById(\'btnN1\').disabled=!S.sheetId" onpaste="setTimeout(function(){S.sheetId=document.getElementById(\'si\').value.trim();document.getElementById(\'btnN1\').disabled=!S.sheetId},100)" onchange="S.sheetId=this.value.trim();document.getElementById(\'btnN1\').disabled=!S.sheetId"><div style="width:100%;max-width:360px"><button class="btn btn-primary" id="btnN1" onclick="S.setupStep=2;render()" '+(S.sheetId?'':'disabled')+'>Siguiente \u2192</button></div></div>';
  if(S.setupStep===2)return'<div class="setup-screen"><div class="step-indicator"><div class="step-dot"></div><div class="step-dot active"></div><div class="step-dot"></div></div><img src="'+LOGO+'" class="setup-logo" onerror="this.style.display=\'none\'"><div class="setup-title">API Key</div><input class="setup-input" id="ak" placeholder="API Key" type="password" value="'+S.apiKey+'" oninput="S.apiKey=this.value.trim();document.getElementById(\'btnN2\').disabled=!S.apiKey" onpaste="setTimeout(function(){S.apiKey=document.getElementById(\'ak\').value.trim();document.getElementById(\'btnN2\').disabled=!S.apiKey},100)" onchange="S.apiKey=this.value.trim();document.getElementById(\'btnN2\').disabled=!S.apiKey"><div style="width:100%;max-width:360px;display:flex;flex-direction:column;gap:10px"><button class="btn btn-primary" id="btnN2" onclick="S.setupStep=3;render()" '+(S.apiKey?'':'disabled')+'>Siguiente \u2192</button><button class="btn btn-secondary" onclick="S.setupStep=1;render()">\u2190</button></div></div>';
  return'<div class="setup-screen"><div class="step-indicator"><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot active"></div></div><img src="'+LOGO+'" class="setup-logo" onerror="this.style.display=\'none\'"><div class="setup-title">URL Apps Script</div><input class="setup-input" id="su" placeholder="https://script.google.com/..." value="'+SCRIPT_URL+'" oninput="SCRIPT_URL=this.value.trim();document.getElementById(\'btnC\').disabled=!SCRIPT_URL" onpaste="setTimeout(function(){SCRIPT_URL=document.getElementById(\'su\').value.trim();document.getElementById(\'btnC\').disabled=!SCRIPT_URL},100)" onchange="SCRIPT_URL=this.value.trim();document.getElementById(\'btnC\').disabled=!SCRIPT_URL"><div style="width:100%;max-width:360px;display:flex;flex-direction:column;gap:10px"><button class="btn btn-primary" id="btnC" onclick="connectSheet()" '+(SCRIPT_URL?'':'disabled')+'>\u{1F50C} Conectar</button><button class="btn btn-secondary" onclick="S.setupStep=2;render()">\u2190</button></div></div>'}

async function connectSheet(){toast('Conectando...');try{await Sheets.read('\u{1F6D2} Cat\u00e1logo','A1:A2');localStorage.setItem('sheetId_compras',S.sheetId);localStorage.setItem('apiKey_compras',S.apiKey);localStorage.setItem('scriptUrl_compras',SCRIPT_URL);await Sheets.loadUsers();S.screen='login';S.connected=true;toast('\u00a1Conectado!');render()}catch(e){toast('Error: Verifica datos',1)}}

function renderLogin(){return'<div class="setup-screen"><img src="'+LOGO+'" class="setup-logo" onerror="this.style.display=\'none\'"><div class="setup-title">\u{1F6D2} Compras</div><div class="setup-desc">Inicia sesi\u00f3n</div><input class="login-input" id="lu" placeholder="\u{1F464} Usuario" autocapitalize="off"><input class="login-input" id="lp" placeholder="\u{1F512} Contrase\u00f1a" type="password" onkeydown="if(event.key===\'Enter\')doLogin()"><div style="width:100%;max-width:360px"><button class="btn btn-primary" onclick="doLogin()">\u{1F511} Entrar</button></div></div>'}

async function doLogin(){const u=document.getElementById('lu').value.trim().toLowerCase(),p=document.getElementById('lp').value;if(!u||!p){toast('Completa campos',1);return}await Sheets.loadUsers();const f=S.usuarios.find(x=>x.usuario.toLowerCase()===u&&x.password===p);if(!f){toast('Credenciales incorrectas',1);return}S.currentUser={id:f.id,usuario:f.usuario,nombre:f.nombre,rol:f.rol};localStorage.setItem('currentUser_compras',JSON.stringify(S.currentUser));S.screen='main';toast('\u00a1Hola, '+f.nombre+'!');await Sheets.loadAll();logAction('Login','Acceso','login')}
function logout(){logAction('Logout','Sali\u00f3','logout');S.currentUser=null;localStorage.removeItem('currentUser_compras');S.screen='login';modalType=null;render();toast('Sesi\u00f3n cerrada')}

function renderMain(){const sc=S.connected?'connected':'';let c='';switch(S.tab){case'home':c=renderHome();break;case'compras':c=renderCompras();break;case'cuadre':c=renderCuadre();break;case'catalogo':c=renderCatalogo();break;case'bitacora':c=renderBitacora();break}
return'<div class="status-bar"><div class="status-left"><div class="status-dot '+sc+'"></div><img src="'+LOGO+'" class="app-logo" onerror="this.textContent=\'\u{1F6D2}\'"></div><div class="status-right"><button class="user-badge" onclick="openModal(\'userMenu\')"><div class="user-avatar">'+uInit()+'</div><span class="user-name">'+uName()+'</span></button><button class="config-btn" onclick="openModal(\'settings\')">\u2699\ufe0f</button></div></div><div class="main-content" id="mc">'+(S.loading?'<div class="empty-state"><div class="empty-icon">\u23f3</div><p>Cargando...</p></div>':c)+'</div><nav class="bottom-nav"><button class="nav-item '+(S.tab==='home'?'active':'')+'" onclick="switchTab(\'home\')"><span class="nav-icon">\u{1F3E0}</span>Inicio</button><button class="nav-item '+(S.tab==='compras'?'active':'')+'" onclick="switchTab(\'compras\')"><span class="nav-icon">\u{1F6D2}</span>Compras</button><button class="nav-item '+(S.tab==='cuadre'?'active':'')+'" onclick="switchTab(\'cuadre\')"><span class="nav-icon">\u{1F4B5}</span>Cuadre</button><button class="nav-item '+(S.tab==='catalogo'?'active':'')+'" onclick="switchTab(\'catalogo\')"><span class="nav-icon">\u{1F4E6}</span>Cat\u00e1logo</button><button class="nav-item '+(S.tab==='bitacora'?'active':'')+'" onclick="switchTab(\'bitacora\')"><span class="nav-icon">\u{1F4DC}</span>Bit\u00e1cora</button></nav>'+renderModal()}

function switchTab(t){S.tab=t;S.searchQuery='';render()}

function renderHome(){const ds=getDaySummary(today());const tc=S.compras.filter(c=>c.fecha===today()).length;
return'<div class="uib"><div class="uib-av">'+uInit()+'</div><div><div class="uib-name">Hola, '+uName()+' \u{1F6D2}</div><div class="uib-role">'+(isAdmin()?'\u{1F511} Administrador':'\u{1F6D2} Comprador')+'</div></div></div><div class="stats-grid"><div class="stat-box green"><div class="stat-number">'+fmt$(ds.asignado)+'</div><div class="stat-label">Asignado Hoy</div></div><div class="stat-box red"><div class="stat-number">'+fmt$(ds.gastado)+'</div><div class="stat-label">Gastado Hoy</div></div><div class="stat-box blue"><div class="stat-number">'+fmt$(ds.disponible)+'</div><div class="stat-label">Disponible</div></div><div class="stat-box orange"><div class="stat-number">'+tc+'</div><div class="stat-label">Compras Hoy</div></div></div><div class="quick-actions"><button class="quick-btn" onclick="openModal(\'compra\')"><span class="quick-icon">\u{1F6D2}</span><span class="quick-label">Compra</span></button>'+(isAdmin()?'<button class="quick-btn" onclick="openModal(\'fondo\')"><span class="quick-icon">\u{1F4B5}</span><span class="quick-label">Fondo</span></button>':'<button class="quick-btn disabled"><span class="quick-icon">\u{1F4B5}</span><span class="quick-label">Fondo</span></button>')+'<button class="quick-btn" onclick="openModal(\'devolucion\')"><span class="quick-icon">\u{1F4B0}</span><span class="quick-label">Devolver</span></button>'+(isAdmin()?'<button class="quick-btn" onclick="openModal(\'addProduct\')"><span class="quick-icon">\u2795</span><span class="quick-label">Producto</span></button><button class="quick-btn" onclick="openModal(\'addProv\')"><span class="quick-icon">\u{1F3EA}</span><span class="quick-label">Proveedor</span></button>':'<button class="quick-btn disabled"><span class="quick-icon">\u2795</span><span class="quick-label">Producto</span></button><button class="quick-btn disabled"><span class="quick-icon">\u{1F3EA}</span><span class="quick-label">Proveedor</span></button>')+'<button class="quick-btn" onclick="Sheets.loadAll()"><span class="quick-icon">\u{1F504}</span><span class="quick-label">Actualizar</span></button></div>'+(ds.asignado>0&&!ds.cerrado?'<div class="cuadre-box '+(ds.disponible<0?'bad':ds.disponible<100?'warn':'ok')+'"><div class="cuadre-row"><span>Asignado</span><span class="cr-val" style="color:var(--green)">'+fmt$(ds.asignado)+'</span></div><div class="cuadre-row"><span>Gastado ('+ds.items+' compras)</span><span class="cr-val" style="color:var(--red)">'+fmt$(ds.gastado)+'</span></div><div class="cuadre-row"><span>Devuelto</span><span class="cr-val" style="color:var(--blue)">'+fmt$(ds.devuelto)+'</span></div><div class="cuadre-row" style="border-top:1px solid rgba(255,255,255,.1);padding-top:10px;margin-top:4px"><span style="font-weight:700">Disponible</span><span class="cr-val" style="color:var(--yellow);font-size:18px">'+fmt$(ds.disponible)+'</span></div></div>':'')+renderRecentCompras()}

function renderRecentCompras(){const rc=S.compras.filter(c=>c.fecha===today()).slice(0,5);if(!rc.length)return'';return'<div class="card"><div class="card-header"><span class="card-title">\u{1F6D2} Compras de Hoy</span></div>'+rc.map(c=>'<div class="record-item"><div class="record-top"><span class="record-product">'+c.producto+'</span><span class="record-qty">'+fmt$(c.precio)+'</span></div><div class="record-meta"><span>'+c.cantidad+' '+c.unidad+'</span><span>\u{1F3EA} '+c.proveedor+'</span><span>\u{1F464} '+c.comprador+'</span><span class="ticket-indicator '+(c.ticket==='SI'?'ticket-si':'ticket-no')+'">'+(c.ticket==='SI'?'\u{1F9FE} Ticket':'\u274c Sin ticket')+'</span></div></div>').join('')+'</div>'}

function renderCompras(){const q=S.searchQuery.toLowerCase();let f=S.compras;if(q)f=f.filter(c=>c.producto.toLowerCase().includes(q)||c.proveedor.toLowerCase().includes(q)||c.comprador.toLowerCase().includes(q));return'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F6D2} Compras</span><button class="btn btn-primary btn-sm" onclick="openModal(\'compra\')">+ Compra</button></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="'+S.searchQuery+'" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">'+renderComprasList(f)+'</div>'}

function renderComprasList(f){return!f.length?'<div class="empty-state"><div class="empty-icon">\u{1F6D2}</div><p>Sin compras</p></div>':f.map(c=>'<div class="record-item">'+(isAdmin()?'<button class="del-btn" onclick="confirmDelCompra(\''+c.id+'\','+c._row+',\''+c.producto.replace(/'/g,"\\'")+'\')">\u{1F5D1}</button>':'')+'<div class="record-top"><span class="record-product">'+c.producto+'</span><span class="record-qty">'+fmt$(c.precio)+'</span></div><div class="record-meta"><span>'+c.cantidad+' '+c.unidad+'</span><span>\u{1F4C5} '+c.fecha+'</span><span>\u{1F3EA} '+c.proveedor+'</span><span>\u{1F464} '+c.comprador+'</span><span class="ticket-indicator '+(c.ticket==='SI'?'ticket-si':'ticket-no')+'">'+(c.ticket==='SI'?'\u{1F9FE}':'\u274c')+'</span></div>'+(c.notas?'<div style="font-size:11px;color:var(--text2);margin-top:6px">\u{1F4DD} '+c.notas+'</div>':'')+'</div>').join('')}

function renderCuadre(){const d=S.cuadreDate||today();const ds=getDaySummary(d);const compras=getDayCompras(d);const fondos=getDayFondos(d);
return'<div style="margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4B5} Cuadre del D\u00eda</span></div><div class="form-group"><input class="form-input" type="date" value="'+dateToISO(d)+'" onchange="S.cuadreDate=isoToDate(this.value);render()" style="text-align:center"></div><div class="cuadre-box '+(ds.cerrado?'ok':ds.disponible<0?'bad':'warn')+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><strong>'+d+'</strong>'+(ds.cerrado?'<span class="badge closed">\u2705 Cerrado</span>':'<span class="badge pending">\u23f3 Abierto</span>')+'</div><div class="cuadre-row"><span>Asignado</span><span class="cr-val" style="color:var(--green)">'+fmt$(ds.asignado)+'</span></div><div class="cuadre-row"><span>Gastado ('+ds.items+')</span><span class="cr-val" style="color:var(--red)">'+fmt$(ds.gastado)+'</span></div><div class="cuadre-row"><span>Devuelto</span><span class="cr-val" style="color:var(--blue)">'+fmt$(ds.devuelto)+'</span></div><div class="cuadre-row" style="border-top:1px solid rgba(255,255,255,.1);padding-top:10px;margin-top:4px"><span style="font-weight:700">Balance</span><span class="cr-val" style="color:'+(ds.disponible<0?'var(--red)':'var(--yellow)')+';font-size:18px">'+fmt$(ds.disponible)+'</span></div></div>'+(isAdmin()&&!ds.cerrado&&ds.asignado>0?'<button class="btn btn-success" onclick="cerrarCuadre(\''+d+'\')">\u2705 Cerrar Cuadre del D\u00eda</button><div style="height:10px"></div>':'')+'<div class="card-title" style="margin:14px 0 8px">\u{1F4B5} Movimientos de Fondos</div>'+(fondos.length?fondos.map(f=>'<div class="record-item"><div class="record-top"><span class="record-product">'+f.tipo+'</span><span class="record-qty" style="color:'+(f.tipo==='Asignaci\u00f3n'?'var(--green)':'var(--blue)')+'">'+fmt$(f.monto)+'</span></div><div class="record-meta"><span>\u{1F552} '+f.hora+'</span><span>\u{1F464} '+f.responsable+'</span>'+(f.notas?'<span>\u{1F4DD} '+f.notas+'</span>':'')+'</div></div>').join(''):'<div class="empty-state" style="padding:20px"><p>Sin fondos asignados</p></div>')+'<div class="card-title" style="margin:14px 0 8px">\u{1F6D2} Compras del D\u00eda</div>'+(compras.length?compras.map(c=>'<div class="record-item"><div class="record-top"><span class="record-product">'+c.producto+'</span><span class="record-qty">'+fmt$(c.precio)+'</span></div><div class="record-meta"><span>'+c.cantidad+' '+c.unidad+'</span><span>\u{1F3EA} '+c.proveedor+'</span><span>\u{1F464} '+c.comprador+'</span></div></div>').join(''):'<div class="empty-state" style="padding:20px"><p>Sin compras</p></div>')}

function dateToISO(d){const p=d.split('/');return p[2]+'-'+p[1]+'-'+p[0]}
function isoToDate(d){const p=d.split('-');return p[2]+'/'+p[1]+'/'+p[0]}

function renderCatalogo(){const q=S.searchQuery.toLowerCase();let f=S.catalogo;if(q)f=f.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q));return'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4E6} Cat\u00e1logo ('+S.catalogo.length+')</span>'+(isAdmin()?'<button class="btn btn-primary btn-sm" onclick="openModal(\'addProduct\')">+ Producto</button>':'')+'</div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="'+S.searchQuery+'" oninput="S.searchQuery=this.value;filterResults()"></div><div class="tab-pills"><button class="tab-pill '+(S.comprasFilter==='todos'?'active':'')+'" onclick="S.comprasFilter=\'todos\';filterResults()">Todos</button>'+getCats().map(c=>'<button class="tab-pill '+(S.comprasFilter===c?'active':'')+'" onclick="S.comprasFilter=\''+c+'\';filterResults()">'+c+'</button>').join('')+'</div><div id="resultsList">'+renderCatList(f)+'</div>'}

function renderCatList(f){if(S.comprasFilter!=='todos')f=f.filter(p=>p.categoria===S.comprasFilter);return!f.length?'<div class="empty-state"><div class="empty-icon">\u{1F4E6}</div><p>Sin productos</p></div>':f.map(p=>'<div class="inv-item">'+(isAdmin()?'<button class="del-btn" onclick="confirmDelProd(\''+p.producto.replace(/'/g,"\\'")+'\')">\u{1F5D1}</button>':'')+'<div style="flex:1;padding-right:'+(isAdmin()?'30px':'0')+'"><div class="inv-name">'+p.producto+'</div><div class="inv-cat">'+p.categoria+' \u00b7 '+p.unidad+(p.precioRef?' \u00b7 Ref: '+fmt$(p.precioRef):'')+'</div></div></div>').join('')}

function renderBitacora(){const q=S.searchQuery.toLowerCase();const f=q?S.bitacora.filter(b=>b.accion.toLowerCase().includes(q)||b.detalle.toLowerCase().includes(q)||b.usuario.toLowerCase().includes(q)):S.bitacora;return'<div style="margin-bottom:14px"><span class="card-title" style="margin:0">\u{1F4DC} Bit\u00e1cora</span></div><div class="search-bar"><span>\u{1F50D}</span><input placeholder="Buscar..." value="'+S.searchQuery+'" oninput="S.searchQuery=this.value;filterResults()"></div><div id="resultsList">'+renderLogList(f)+'</div>'}
function renderLogList(f){return!f.length?'<div class="empty-state"><div class="empty-icon">\u{1F4DC}</div><p>Sin registros</p></div>':f.map(b=>'<div class="record-item"><div style="font-size:13px;font-weight:600">'+b.accion+'</div><div style="font-size:12px;margin:4px 0">'+b.detalle+'</div><div class="record-meta"><span>\u{1F4C5} '+b.fecha+'</span><span>\u{1F552} '+b.hora+'</span><span>\u{1F464} '+b.usuario+'</span></div></div>').join('')}

function filterResults(){const l=document.getElementById('resultsList');if(!l)return;const q=S.searchQuery.toLowerCase();if(S.tab==='compras'){let f=S.compras;if(q)f=f.filter(c=>c.producto.toLowerCase().includes(q)||c.proveedor.toLowerCase().includes(q));l.innerHTML=renderComprasList(f)}
else if(S.tab==='catalogo'){let f=S.catalogo;if(q)f=f.filter(p=>p.producto.toLowerCase().includes(q)||p.categoria.toLowerCase().includes(q));l.innerHTML=renderCatList(f)}
else if(S.tab==='bitacora'){const f=q?S.bitacora.filter(b=>b.accion.toLowerCase().includes(q)||b.detalle.toLowerCase().includes(q)):S.bitacora;l.innerHTML=renderLogList(f)}}

let modalType=null;
function renderModal(){if(!modalType)return'';let c='';if(modalType==='compra')c=fmCompra();if(modalType==='fondo')c=fmFondo();if(modalType==='devolucion')c=fmDevolucion();if(modalType==='addProduct')c=fmAddProd();if(modalType==='addProv')c=fmAddProv();if(modalType==='settings')c=fmSettings();if(modalType==='userMenu')c=fmUser();return'<div class="modal-overlay active" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal"><div class="modal-handle"></div>'+c+'</div></div>'}
function openModal(t){if((t==='addProduct'||t==='addProv'||t==='fondo')&&!isAdmin()){toast('Solo admin',1);return}modalType=t;_cartCompra=[];_acSelected={};render()}
function closeModal(){modalType=null;_cartCompra=[];render()}

function fmUser(){return'<div class="modal-title">\u{1F464} Mi Cuenta</div><div style="text-align:center;margin-bottom:20px"><div style="width:60px;height:60px;border-radius:16px;background:var(--accent);color:#0f1a14;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;margin:0 auto 12px">'+uInit()+'</div><div style="font-size:18px;font-weight:700">'+uName()+'</div><div style="font-size:13px;color:var(--text2);margin-top:4px">@'+(S.currentUser?.usuario||'')+'</div></div><button class="btn btn-danger" onclick="logout()">\u{1F6AA} Cerrar Sesi\u00f3n</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'}

function fmCompra(){const cats=getCats();const provs=getProvs();return'<div class="modal-title">\u{1F6D2} Registrar Compra</div><div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;display:flex;align-items:center;gap:8px"><span>\u{1F464}</span><strong>'+uName()+'</strong></div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fCC" onchange="updSelC(this.value)"><option value="">Seleccionar...</option>'+cats.map(function(c){return'<option value="'+c+'">'+c+'</option>'}).join('')+'</select></div><div class="form-group"><label class="form-label">Producto</label><div id="fCPWrap"><div class="autocomplete-wrap"><input class="form-input" id="fCP" placeholder="\u{1F50D} Buscar producto..." oninput="acInputFor(\'fCP\')" onfocus="acInputFor(\'fCP\')" autocomplete="off"><div class="autocomplete-list" id="fCPList"></div></div></div></div><div style="display:flex;gap:10px"><div class="form-group" style="flex:1"><label class="form-label">Cantidad</label><input class="form-input" id="fCQ" type="number" inputmode="decimal" placeholder="0" min="0.1" step="0.1"></div><div class="form-group" style="flex:1"><label class="form-label">Precio $</label><input class="form-input" id="fCPr" type="number" inputmode="decimal" placeholder="0.00" min="0" step="0.01"></div></div><div class="form-group"><label class="form-label">Proveedor</label><div id="fCPvWrap"><div class="autocomplete-wrap"><input class="form-input" id="fCPv" placeholder="\u{1F50D} Buscar proveedor..." oninput="acInputFor(\'fCPv\')" onfocus="acInputFor(\'fCPv\')" autocomplete="off"><div class="autocomplete-list" id="fCPvList"></div></div></div></div><div class="form-group"><label class="form-label">\u00bfTiene ticket?</label><select class="form-select" id="fCT"><option value="SI">\u{1F9FE} S\u00ed</option><option value="NO">\u274c No</option></select></div><div class="form-group"><label class="form-label">Notas (opcional)</label><textarea class="form-textarea" id="fCN" placeholder="Observaciones..."></textarea></div><button class="btn btn-secondary" onclick="addToCartCompra()">\u2795 Agregar a lista</button><div id="cartCompra">'+renderCartCompra()+'</div><div class="cart-divider"></div><button class="btn btn-primary" onclick="submitCartCompra()" '+(_cartCompra.length===0?'disabled':'')+' id="btnSaveCompra">\u2705 Guardar Todo ('+_cartCompra.length+')</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>'}

function updSelC(cat){_acSelected.fCP='';const wrap=document.getElementById('fCPWrap');if(wrap)wrap.innerHTML='<div class="autocomplete-wrap"><input class="form-input" id="fCP" placeholder="\u{1F50D} Buscar producto..." oninput="acInputFor(\'fCP\')" onfocus="acInputFor(\'fCP\')" autocomplete="off"><div class="autocomplete-list" id="fCPList"></div></div>'}

function fmFondo(){return'<div class="modal-title">\u{1F4B5} Asignar Fondo</div><div class="form-group"><label class="form-label">Monto $</label><input class="form-input" id="fFM" type="number" inputmode="decimal" placeholder="0.00" min="1" step="0.01"></div><div class="form-group"><label class="form-label">Notas (opcional)</label><textarea class="form-textarea" id="fFN" placeholder="Ej: Compras del d\u00eda..."></textarea></div><button class="btn btn-success" onclick="subFondo()">\u2705 Asignar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>'}

function fmDevolucion(){return'<div class="modal-title">\u{1F4B0} Devolver Sobrante</div><div style="background:var(--surface2);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px"><span>\u{1F464} '+uName()+'</span></div><div class="form-group"><label class="form-label">Monto a devolver $</label><input class="form-input" id="fDM" type="number" inputmode="decimal" placeholder="0.00" min="0.01" step="0.01"></div><div class="form-group"><label class="form-label">Notas (opcional)</label><textarea class="form-textarea" id="fDN" placeholder="Observaciones..."></textarea></div><button class="btn btn-blue" onclick="subDevolucion()">\u2705 Devolver</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>'}

function fmAddProd(){if(!isAdmin())return'<div class="modal-title">\u{1F512} Solo admin</div>';const cats=getCats();return'<div class="modal-title">\u2795 Nuevo Producto</div><div class="form-group"><label class="form-label">Categor\u00eda</label><select class="form-select" id="fNPC"><option value="">Seleccionar...</option>'+cats.map(function(c){return'<option value="'+c+'">'+c+'</option>'}).join('')+'<option value="__new__">\uff0b Nueva...</option></select></div><div id="newCatField" style="display:none"><div class="form-group"><label class="form-label">Nueva Categor\u00eda</label><input class="form-input" id="fNCN" placeholder="Nombre"></div></div><div class="form-group"><label class="form-label">Producto</label><input class="form-input" id="fNPN" placeholder="Ej: Tomate Saladette kg"></div><div class="form-group"><label class="form-label">Unidad</label><select class="form-select" id="fNPU"><option value="kg">kg</option><option value="lt">lt</option><option value="pza">pza</option><option value="paq">paq</option><option value="caja">caja</option><option value="bolsa">bolsa</option><option value="bote">bote</option><option value="manojo">manojo</option></select></div><div class="form-group"><label class="form-label">Precio Referencia $ (opcional)</label><input class="form-input" id="fNPP" type="number" inputmode="decimal" placeholder="0.00" step="0.01"></div><button class="btn btn-secondary" onclick="addToCartNewProd()">\u2795 Agregar a lista</button><div id="cartNewProd">'+renderCartNewProd()+'</div><div class="cart-divider"></div><button class="btn btn-success" onclick="submitCartNewProd()" '+(_cartNewProd.length===0?'disabled':'')+' id="btnSaveNewProd">\u2705 Guardar Todo ('+_cartNewProd.length+')</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>'}

function fmAddProv(){return'<div class="modal-title">\u{1F3EA} Nuevo Proveedor</div><div class="form-group"><label class="form-label">Nombre</label><input class="form-input" id="fPvN" placeholder="Ej: Fruter\u00eda Don Juan"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" id="fPvT"><option value="Local">Local</option><option value="Cadena">Cadena/Supermercado</option><option value="Mayorista">Mayorista</option></select></div><button class="btn btn-success" onclick="subNewProv()">\u2705 Agregar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">\u2716 Cerrar</button>'}

function fmSettings(){return'<div class="modal-title">\u2699\ufe0f Config</div><div class="form-group"><label class="form-label">Sheet ID</label><input class="form-input" value="'+S.sheetId+'" id="sS" style="font-size:11px"></div><div class="form-group"><label class="form-label">API Key</label><input class="form-input" value="'+S.apiKey+'" id="sA" type="password" style="font-size:11px"></div><div class="form-group"><label class="form-label">Script URL</label><input class="form-input" value="'+SCRIPT_URL+'" id="sU" style="font-size:11px"></div><button class="btn btn-primary" onclick="saveSett()">\u{1F4BE} Guardar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="resetApp()" style="color:var(--red)">\u{1F5D1} Desconectar</button><div style="height:10px"></div><button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'}

document.addEventListener('change',function(e){if(e.target.id==='fNPC'){const f=document.getElementById('newCatField');if(f)f.style.display=e.target.value==='__new__'?'block':'none'}});

let _cartCompra=[];
function addToCartCompra(){const cat=document.getElementById('fCC').value,prod=acGetVal('fCP'),qty=document.getElementById('fCQ').value,precio=document.getElementById('fCPr').value,prov=acGetVal('fCPv'),ticket=document.getElementById('fCT').value,notas=document.getElementById('fCN').value;if(!prod||!qty||!precio||!prov){toast('Completa campos',1);return}const p=S.catalogo.find(x=>x.producto===prod);_cartCompra.push({cat:cat||p?.categoria||'',prod,qty:parseFloat(qty),unidad:p?.unidad||'',precio:parseFloat(precio),prov,ticket,notas});toast(prod+' '+fmt$(parseFloat(precio)));acClearC('fCP');document.getElementById('fCQ').value='';document.getElementById('fCPr').value='';document.getElementById('fCN').value='';document.getElementById('cartCompra').innerHTML=renderCartCompra();const btn=document.getElementById('btnSaveCompra');if(btn){btn.disabled=false;btn.innerHTML='\u2705 Guardar Todo ('+_cartCompra.length+')'}}
function removeCartCompra(i){_cartCompra.splice(i,1);document.getElementById('cartCompra').innerHTML=renderCartCompra();const btn=document.getElementById('btnSaveCompra');if(btn){btn.disabled=_cartCompra.length===0;btn.innerHTML='\u2705 Guardar Todo ('+_cartCompra.length+')'}}
function renderCartCompra(){if(!_cartCompra.length)return'';const total=_cartCompra.reduce(function(s,c){return s+c.precio},0);return'<div class="cart-header"><span class="ch-title">\u{1F6D2} Lista</span><span class="ch-count">'+_cartCompra.length+' items</span></div>'+_cartCompra.map(function(c,i){return'<div class="cart-item"><div class="ci-info"><div class="ci-name">'+c.prod+'</div><div class="ci-meta">'+c.qty+' '+c.unidad+' \u00b7 '+c.prov+(c.ticket==='SI'?' \u00b7 \u{1F9FE}':'')+'</div></div><span class="ci-price">'+fmt$(c.precio)+'</span><button class="ci-del" onclick="removeCartCompra('+i+')">\u2716</button></div>'}).join('')+'<div class="cart-total"><span class="ct-label">Total</span><span class="ct-amount">'+fmt$(total)+'</span></div>'}
async function submitCartCompra(){if(!_cartCompra.length)return;const total=_cartCompra.length;let ok=0;const n=now();for(const c of _cartCompra){const id=nextId('C',S.compras);try{await Sheets.append('\u{1F9FE} Compras',[id,n.date,n.time,c.cat,c.prod,c.qty,c.unidad,c.precio,c.prov,c.ticket,uName(),c.notas]);ok++}catch(e){toast('Error en '+c.prod,1)}}const totalMoney=_cartCompra.reduce(function(s,c){return s+c.precio},0);await logAction('Compras registradas',ok+' items por '+fmt$(totalMoney),'compra');_cartCompra=[];toast(ok+'/'+total+' compras guardadas');closeModal();Sheets.loadAll()}

let _cartNewProd=[];
function addToCartNewProd(){let cat=document.getElementById('fNPC').value;const nc=document.getElementById('fNCN')?.value?.trim()||'';const nm=document.getElementById('fNPN').value.trim();const un=document.getElementById('fNPU').value;const pr=document.getElementById('fNPP').value||'0';if(cat==='__new__'){if(!nc){toast('Escribe categor\u00eda',1);return}cat=nc}if(!cat||!nm){toast('Completa campos',1);return}if(isDup(nm,cat)||_cartNewProd.some(function(c){return c.nombre.toLowerCase()===nm.toLowerCase()})){toast('Ya existe',1);return}_cartNewProd.push({cat,nombre:nm,unidad:un,precioRef:parseFloat(pr)});toast(nm+' agregado');document.getElementById('fNPN').value='';document.getElementById('fNPP').value='';document.getElementById('cartNewProd').innerHTML=renderCartNewProd();const btn=document.getElementById('btnSaveNewProd');if(btn){btn.disabled=false;btn.innerHTML='\u2705 Guardar Todo ('+_cartNewProd.length+')'}}
function removeCartNewProd(i){_cartNewProd.splice(i,1);document.getElementById('cartNewProd').innerHTML=renderCartNewProd();const btn=document.getElementById('btnSaveNewProd');if(btn){btn.disabled=_cartNewProd.length===0;btn.innerHTML='\u2705 Guardar Todo ('+_cartNewProd.length+')'}}
function renderCartNewProd(){if(!_cartNewProd.length)return'';return'<div class="cart-header"><span class="ch-title">Productos</span><span class="ch-count">'+_cartNewProd.length+'</span></div>'+_cartNewProd.map(function(c,i){return'<div class="cart-item"><div class="ci-info"><div class="ci-name">'+c.nombre+'</div><div class="ci-meta">'+c.cat+' \u00b7 '+c.unidad+(c.precioRef?' \u00b7 Ref: '+fmt$(c.precioRef):'')+'</div></div><button class="ci-del" onclick="removeCartNewProd('+i+')">\u2716</button></div>'}).join('')}
async function submitCartNewProd(){if(!_cartNewProd.length||!isAdmin())return;let ok=0;for(const c of _cartNewProd){const id=nextId('P',S.catalogo);try{await Sheets.append('\u{1F6D2} Cat\u00e1logo',[id,c.cat,c.nombre,c.unidad,c.precioRef,'SI']);await logAction('Producto agregado',c.nombre,'add');ok++}catch(e){toast('Error',1)}}_cartNewProd=[];toast(ok+' productos guardados');closeModal();Sheets.loadAll()}

async function subFondo(){if(!isAdmin())return;const m=document.getElementById('fFM').value,n=document.getElementById('fFN').value;if(!m||parseFloat(m)<=0){toast('Ingresa monto',1);return}const id=nextId('F',S.fondos);const t=now();try{await Sheets.append('\u{1F4B5} Fondos',[id,t.date,t.time,'Asignaci\u00f3n',parseFloat(m),uName(),n]);await logAction('Fondo asignado',fmt$(parseFloat(m)),'fondo');toast('Fondo: '+fmt$(parseFloat(m)));closeModal();Sheets.loadAll()}catch(e){toast('Error',1)}}

async function subDevolucion(){const m=document.getElementById('fDM').value,n=document.getElementById('fDN').value;if(!m||parseFloat(m)<=0){toast('Ingresa monto',1);return}const id=nextId('F',S.fondos);const t=now();try{await Sheets.append('\u{1F4B5} Fondos',[id,t.date,t.time,'Devoluci\u00f3n',parseFloat(m),uName(),n]);await logAction('Devoluci\u00f3n',fmt$(parseFloat(m)),'devolucion');toast('Devuelto: '+fmt$(parseFloat(m)));closeModal();Sheets.loadAll()}catch(e){toast('Error',1)}}

async function cerrarCuadre(d){const ds=getDaySummary(d);showConfirm('\u2705 Cerrar Cuadre','Cerrar cuadre de '+d+'?<br>Gastado: '+fmt$(ds.gastado)+'<br>Balance: '+fmt$(ds.disponible),async function(){const id=nextId('F',S.fondos);const t=now();try{await Sheets.append('\u{1F4B5} Fondos',[id,d,t.time,'Cierre',0,uName(),'Cuadre cerrado - Balance: '+fmt$(ds.disponible)]);await logAction('Cuadre cerrado',d+' - Balance: '+fmt$(ds.disponible),'cierre');toast('Cuadre cerrado');Sheets.loadAll()}catch(e){toast('Error',1)}})}

async function subNewProv(){const nm=document.getElementById('fPvN').value.trim(),tp=document.getElementById('fPvT').value;if(!nm){toast('Escribe nombre',1);return}if(S.proveedores.some(function(p){return p.nombre.toLowerCase()===nm.toLowerCase()})){toast('Ya existe',1);return}const id=nextId('PV',S.proveedores);try{await Sheets.append('\u{1F3EA} Proveedores',[id,nm,tp,'SI']);await logAction('Proveedor agregado',nm+' ('+tp+')','add');toast(nm+' agregado');closeModal();Sheets.loadAll()}catch(e){toast('Error',1)}}

function confirmDelCompra(id,row,prod){showConfirm('\u{1F5D1} Eliminar','Eliminar compra de '+prod+'?',async function(){try{await Sheets.deleteRow('\u{1F9FE} Compras',row);await logAction('Compra eliminada',prod,'delete');toast('Eliminada');Sheets.loadAll()}catch(e){toast('Error',1)}})}
function confirmDelProd(prod){showConfirm('\u{1F5D1} Eliminar','Eliminar '+prod+'?',async function(){const p=S.catalogo.find(function(x){return x.producto===prod});if(!p)return;try{await Sheets.deleteRow('\u{1F6D2} Cat\u00e1logo',p._row);await logAction('Producto eliminado',prod,'delete');toast('Eliminado');Sheets.loadAll()}catch(e){toast('Error',1)}})}

function saveSett(){S.sheetId=document.getElementById('sS').value;S.apiKey=document.getElementById('sA').value;SCRIPT_URL=document.getElementById('sU').value;localStorage.setItem('sheetId_compras',S.sheetId);localStorage.setItem('apiKey_compras',S.apiKey);localStorage.setItem('scriptUrl_compras',SCRIPT_URL);toast('Guardado');closeModal();Sheets.loadAll()}
function resetApp(){localStorage.removeItem('sheetId_compras');localStorage.removeItem('apiKey_compras');localStorage.removeItem('scriptUrl_compras');localStorage.removeItem('currentUser_compras');S.sheetId='';S.apiKey='';SCRIPT_URL='';S.screen='setup';S.setupStep=1;S.connected=false;S.currentUser=null;closeModal();render()}

(async function(){if(S.sheetId&&S.apiKey&&SCRIPT_URL){const su=localStorage.getItem('currentUser_compras');if(su){try{S.currentUser=JSON.parse(su);S.screen='main';S.connected=true;render();await Sheets.loadUsers();const ok=S.usuarios.find(function(u){return u.usuario===S.currentUser.usuario});if(!ok){toast('Cuenta deshabilitada',1);logout();return}await Sheets.loadAll()}catch(e){S.screen='login';render()}}else{S.screen='login';S.connected=true;await Sheets.loadUsers();render()}}else{render()}})();
</script>
</body>
</html>